---
title: "Stat331: FinalProject"
author: "Alea Seifert, Robelyn Felices, Franchesca Garcia, and Libby Brill"
embed-resources: true
format: 
  html:
    self-contained: true
    code-tools: true
    toc: true
editor: source
code-fold: true
execute: 
  error: true
  echo: true
  message: false
  warning: false
---

## Introduction

#### Data Description

For our final project, we chose to focus on CO$_{2}$ emissions per capita and life expectancy. We use data sets taken from Gapminder, which have been combined and collected from a variety of sources. The co2_emissions data set contains 194 observations (countries) with 224 variables (ranging in year from 1800 to 2022). These data represent the recorded consumption-based CO$_{2}$ emissions, in tonnes of CO$_{2}$ per capita. The life_expectancy data set contains 195 observations (countries) with 302 variables (ranging in year from 1800 to 2100). These data represent the number of years a newborn infant would live assuming the mortality rate at their birth remains constant throughout their life.

#### Data Cleaning

```{r setup}
# load in data
library(tidyverse)
library(gganimate)
library(gifski)
library(broom)
library(kableExtra)
library(scales)
```

```{r data}
# Data
co2_emissions <- read_csv(here::here("co2_pcap_cons.csv"))
life_expectancy <- read_csv(here::here("lex.csv"))

# Pivoting Longer
co2_emissions_long <- co2_emissions |>
  mutate(across(`1800`:`2022`, ~ str_replace_all(.x, "−", "-"))) |>
  mutate(across(`1800`:`2022`, ~ as.numeric(.x))) |>
  pivot_longer(
    cols = `1800`:`2022`,
    names_to = "year",
    values_to = "co2"
  )

life_exp_long <- life_expectancy |>
  mutate(across(`1800`:`2100`, ~ as.numeric(.x))) |>
  pivot_longer(
    cols = `1800`:`2100`,
    names_to = "year",
    values_to = "life_exp"
  )

# Join Datasets
project_data <- co2_emissions_long |>
  inner_join(life_exp_long,
    by = c("country", "year")
  ) |>
  mutate(year = as.numeric(year))

```
We pivoted both data sets to be in long format, them combined them into a singular data set containing variables for country, year, CO$_{2}$ emissions, and life expectancy. The resultant observational unit is a combination of country and year. Country and year pairings that were not included in both of the original data sets were excluded.

When pivoting the data, we received some warnings that resulted from R reading in the negative dashes as character values as opposed to numeric, specifically in our CO$_{2}$ emissions data. To fix this issue, we replaced all dash symbols with the appropriate negative sign. This process was only applied for the CO$_{2}$ emissions data. Both data sets were then completely converted to character values.

#### Hypothesized Relationship

In our model we will analyze CO$_{2}$ emissions as the explanatory variable and life expectancy as the response variable. We expect a negative relationship between CO$_{2}$ emissions and life expectancy, where countries that produce greater amounts of CO$_{2}$ tend to have lower life expectancy. We assume CO$_{2}$ emissions decrease air quality and cause respiratory issues, decreasing life expectancy.

## Linear Regression Analysis

#### Data Visualization

```{r}
#| fig-cap: "Figure 1."
#| fig-align: center

# Visualization 1:
animated <- project_data |>
  ggplot(aes(x = co2, 
             y = life_exp)) +
  geom_point(alpha = 0.7, show.legend = FALSE,
             na.rm = TRUE) +
  labs(title = "CO2 Emissions vs. Life Expectancy per Year: {round(frame_time)}",
       x = "CO2 Emissions (tonnes per capita)",
       y = "",
       subtitle = "Life Expectancy (years)") +
  transition_time(year) +
  ease_aes("linear") +
  theme_bw()

animate(animated, renderer = gifski_renderer(), fps = 7)
```

Figure 1 depicts the relationship between the explanatory variable of carbon dioxide emissions per capita in tonnes and the response variable of life expectancy in years over years 1800 to 2022. It appears that with each year, both CO$_{2}$ emissions and life expectancy increase. They likely both increase over time due to technology advancements. While the effects of CO$_{2}$ emissions can create an impact on an individuals health, society still progresses in fields such as health care.

```{r}
#| fig-cap: "Figure 2."
#| fig-align: center

# Visualization 2:
project_data |>
  group_by(country) |>
  summarize(avg_co2 = mean(co2),
            avg_life_exp = mean(life_exp)) |>
  ggplot(aes(x = avg_co2,
             y = avg_life_exp)) +
  geom_jitter(na.rm = TRUE) +
  geom_smooth(method = "lm", na.rm = TRUE) +
  theme_bw() +
  labs(title = "Averge CO2 Emissions and Life Expectancy per Country",
       x = "Average CO2 Emissions (tonnes per capita)",
       y = NULL,
       subtitle = "Average Life Expectancy (years)")

```

Figure 2 depicts the average carbon dioxide emissions per capita in tonnes per country and the average life expectancy per country over the years 1800 to 2022. It appears that there is positive weak to moderate linear relationship between the two variable. In addition to the apparent increase in life expectancy as CO$_{2}$ emissions increase, there also appears to be a curved pattern as emissions increase, there is a steep slope, but it plateaus as emissions rise.

#### Linear Regression Model

We used Simple Linear Regression (SLR) to fit a linear model between our variables. By using SLR, we assume that there is a linear relationship between average CO$_{2}$ emissions and average life expectancy per country, and we can use that to estimate a country’s average life expectancy (response variable) based on their average CO$_{2}$ emissions (explanatory variable). This function will be of the following form: response = intercept + slope \* explanatory. Therefore, we can predict the average life expectancy of a country by multiplying their average CO$_{2}$ emissions by the model slope and adding the model intercept.

```{r}
#| fig-cap: "Figure 3."
#| fig-align: center

# Model:
project_lm <- project_data |>
  group_by(country) |>
  summarize(avg_co2 = mean(co2),
            avg_life_exp = mean(life_exp))
project_lm <- lm(avg_life_exp ~ avg_co2,
                 data = project_lm)

# Coefficients:
project_lm |>
  broom::tidy() |>
  mutate(p.value = scales::pvalue(p.value)) |>
  knitr::kable(digits = 3)
```

$\widehat{y} = 41.149 + 1.806x$

Our estimated response variable ($\widehat{y}$) is estimated life expectancy and our explanatory variable ($x$) is CO$_{2}$ emissions. Our simple linear model provided us with the information that the average life expectancy is 41.149 years when carbon dioxide emissions are zero. The slope term in our model is stating that for every additional one tonne per capita of CO$_{2}$ emissions, the estimated life expectancy goes up by 1.806 years, on average.

This relationship makes sense because as mentioned, over time there have been developments that allow access to improved healthcare and sanitation; this can contribute to the positive growth in the estimated life expectancy essentially overpowering the effects of the CO$_{2}$ emissions. In addition, advancing as a society, individuals might learn to be more aware/educated on this matter, advocating to find ways to regulate this source of pollution in order to reduce environmental hazards that can impact life expectancy.

#### Model Fit

```{r}
#| fig-cap: "Figure 4."
#| fig-align: center

project_lm |> 
  broom::augment() |> 
ggplot(aes(x = .fitted, y = .resid)) +
  geom_point() + 
  labs(x = "Fitted Values",
       y = "Residuals") +
  geom_abline(slope = 0,
              intercept = 0, 
              color = "steelblue",
              linetype = "dashed",
              lwd = 1.5) +
  theme_bw()
```

We can assume independence because we are observing average values of life expectancy per country. Each country should generally have its own state of conditions that determine life expectancy. If we did not average our data, meaning there are multiple observational rows per country, then independence would be violated.

We can assume normality because a histogram of our data's life expectancies averaged across years per country is fairly bell shaped. The distribution is slightly right skewed, but our sample size of countries is large ($n$ = 193) so should still be reliable.

We can assume equal variance because the points of a residuals versus fits based on a SLR model, although shift up and down, do not appear to fan in or out.

However, we cannot assume linearity because there is a slight curve seen in the visualization of the relationship between CO$_{2}$ emissions and life expectancy in our data (Fig. 2), as well as in the linear model's residuals versus fits plot. Thus, we should proceed with caution when interpreting results produced by a linear regression model.

```{r}
#| fig-cap: "Figure 5."
#| fig-align: center

augment(project_lm) |>
  summarize(var_response = var(avg_life_exp),
            var_fit = var(.fitted),
            var_resid = var(.resid)) |>
  mutate(var_prop = var_fit/var_response) |>
  kable(digits = 3) |>
    kable_styling(latex_options = "basic",
                  position = "center",
                  row_label_position = "c")
```

The table shows 42.41% of variability in life expectancy is explained by our linear regression model using CO$_{2}$ emissions as a predictor ($14.02/33.04 = 0.4241$). Accounting for not even half of the variability, this does not appear to be a particularly strong model of life expectancy.

## Simulation

#### Visualizing Simulations from the Model

```{r}
#| layout-ncol: 2
#| fig-cap: "Figure 6."
#| fig-align: center

# observed plot
project_data |>
  group_by(country) |>
  summarize(avg_co2 = mean(co2),
            avg_life_exp = mean(life_exp)) |>
  ggplot(aes(x = avg_co2,
             y = avg_life_exp)) +
  geom_point(na.rm = TRUE) +
  theme_bw() +
  labs(title = "Observed Life Expectancy per Country",
       x = "Average CO2 Emissions (tonnes per capita)",
       y = NULL,
       subtitle = "Average Life Expectancy (years)") +
  ylim(25, 70)

# simulated plot
simulation <- as.vector(predict(project_lm) + rnorm(n = 186, mean = 0, sd = sigma(project_lm)))
sim_data <- project_data |>
  group_by(country) |>
  summarize(avg_life_exp = mean(life_exp),
            avg_co2 = mean(co2)) |>
  filter(!is.na(avg_life_exp)) |>
  mutate(sim = simulation)

sim_data |>
  ggplot(mapping = aes(x = avg_co2, y = sim)) +
  geom_point(na.rm = TRUE) +
  labs(
    title = "Simulated Life Expectancy per Country based on Linear Regression Model",
    x = "Average CO2 Emissions (tonnes per capita)",
    y = "",
    subtitle = "Average Life Expectancy (years)"
  ) +
  theme_bw() +
  ylim(25, 70)
```

Comparing plots of the observed life expectancies and simulated life expectancies against CO$_{2}$ emissions, while their directions and strengths are similar, the simulated values are noticeably more linear in form as they are based on the SLR model and the observed values follow a curved shape. The simulated data consequently also have lower minimum values and higher maximum values.

#### Generating Multiple Predictive Checks

```{r}
#| fig-cap: "Figure 7."
#| fig-align: center

nsims <- 1000
sims <- map_dfc(
  .x = 1:nsims,
  .f = ~ tibble(sim = as.vector(predict(project_lm) + rnorm(
    n = 186,
    mean = 0,
    sd = sigma(project_lm)
  )))
)

colnames(sims) <- colnames(sims) |>
  str_replace(
    pattern = "\\.\\.\\.",
    replace = "_"
  )

sims <- project_data |>
  group_by(country) |>
  summarize(avg_life_exp = mean(life_exp)) |>
  filter(!is.na(avg_life_exp)) |>
  select(avg_life_exp) |>
  bind_cols(sims)

sims_r <- sims |>
  map(~ lm(avg_life_exp ~ .x,
    data = sims
  )) |>
  map(glance) |>
  map_dbl(~ .x$r.squared)

sims_r <- sims_r[names(sims_r) != "avg_life_exp"]

tibble(sims = sims_r) |>
  ggplot(aes(x = sims)) +
  geom_histogram(binwidth = 0.025) +
  labs(title = expression("Distribution of Simulated" ~ R^2),
    x = expression("Simulated" ~ R^2),
    y = "",
    subtitle = "Number of Simulated Models"
  ) +
  theme_bw()
```

The $R^{2}$ value tells us how well the simulated data matches the observed data. It is calculated on a scale from 0 to 1, with $R^{2}$ values closer to 1 signifying a stronger model. Since the $R^{2}$ value of the observed average life expectancy and the simulated average life expectancy is relatively small, only about `r round(median(sims_r), 4)`, we can conclude that our simulated linear regression model does not match our observed data very well and does not have very strong predictive ability. This is understandable due to the fact that our original linear model assumptions were not met - specifically the condition of linearity. Since our original observed data was not very linear, it follows that a linear model would not be the best fit.
